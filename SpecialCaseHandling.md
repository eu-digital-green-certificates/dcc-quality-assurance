# Handling of Special Cases

This repository contains some QR codes which special cases which needs special handling during the CBOR Decoding/JSON Processing. 

In general for Issuers: once you have generated a QR code, please "close the loop" and attempt to de-serialize and 
validate the contents again. In order to help ensure that your Issuer (at least for EU purposes only) generates clean and 
tight JSON, set  the JSON Schema field `additionalProperties` to `false`. Note that this should only be 
set to true for your own internal validation purposes. For production deployment, the field `additionalProperties` should 
not be explicitly set by the issuance software. 

| Description| Occurence| Verifier Action | Issuer Action| QR Code|
|---------|----|----- |----|---|
| Whitespaces in decoded JSON fields| GR/EL QR Vaccination Codes in Field "mp" | During CBOR deserialization, all text fields SHOULD be trimmed at beginning and end to remove unnecessary whitespace. | Issuers MUST trim unnecessary whitespace at beginning and end of text fields before generating JSON payload.
| Date of Birth with invalid pattern| BG QR Codes | If the schema is validated during Verification, only the DOB regex should be applied. In particular, do not use popular validation framework date / date-time data types as these are often only partially compliant to ISO8601. If validation fails, check to see if there is a timestamp present (begins with 'T'). If so, then remove then time part (inclusive of 'T') and re-validate.| Ensure you generate the field **strictly** in accordance with the DCC Schema DOB regex. | <img src="https://github.com/eu-digital-green-certificates/dcc-quality-assurance/raw/main/BG/1.0.0/specialcases/VAC-NULL-DATETIME.png">
| Dates with invalid Pattern| BG QR Codes in dob field, PL codes in other date fields| As per "DOB with invalid pattern". |  Generate solely as per DCC Schema. |<img src="https://github.com/eu-digital-green-certificates/dcc-quality-assurance/blob/main/PL/1.0.0/specialcases/VAC-13.png?raw=true">
| t,v,r Entries have null values| BG QR Codes for v/t/r | Schema validation should check for ["null","array"]. Only in case of further Schema validation should "One of" be ignored and then the business rules must decide what to do accept / reject in case of multiple entries. | There is no reason to generate null values. .NET : check the JSON serializer options and set accordingly, do not just assume "default is good enough". Before generating the QR payload any null entries should be removed entirely e.g. if t group is null, then remove the t group completely from the JSON. | <img src="https://github.com/eu-digital-green-certificates/dcc-quality-assurance/blob/main/BG/1.0.0/specialcases/VAC-NULL-DATETIME.png?raw=true">
| Negative doses/Invalid Doses| LV QR Code in Vaccination Certificate (not productive, problem fixed) | Number of doses has in schema a min/max value. Upon validation fail, Verifiers can choose whether they wish to accept a number a value that is not in accordance with the DCC Schema restrictions. | Generate number of doses within the DCC Schema defined range. There is no requirement to generate any dose number values outside of the DCC Schema specified range.  
| "null/nil/undefined" values in CBOR| Several QR Codes. Problem occurs when the JSON schema is just used to generate Objects which are filled and serialized later without additional schema validation (JSON creation not performed). | All verifiers shall remove null/undefined values during the cbor deserialization.| All serializers which are used, must be configured/tested to omitting null values to CBOR. An additional schema validation can help avoid this problem from occuring.  | <img src="https://github.com/eu-digital-green-certificates/dcc-quality-assurance/blob/main/LV/1.0.0/specialcases/TEST_NULL_values_in_nm_ma.png?raw=true">    
| Standardized Name fields (fnt/gnt) with special characters| Several QR Codes | Accept any string.| Issuer must strictly check for pattern after the serialization to CBOR. | <img src="https://github.com/eu-digital-green-certificates/dcc-quality-assurance/blob/b6664861b3bf2a982a6fe9776aa6992a76420e6e/NO/VAC.png?raw=true"/>
| Escaped characters in CBOR content| HU/UA QR Codes | Verifiers should escape " correctly with \\" otherwise the JSON parsing fails. | Issuers should avoid the usage of JSON special characters, because not all CBOR implementations deserialize directly. | <img src="https://github.com/eu-digital-green-certificates/dcc-quality-assurance/blob/main/HU/1.3.0/specialcases/TEST_RAT.png?raw=true">
| QR Code contains Version 1.3 Schema, but field "dr" is empty string and as optional in the Test QR Code | NL Test QR Codes | Verifiers by default will ignore this field from Schema 1.1.0 onwards. For Schema v 1.1.0 and earlier: this value must be completed with a valid date. | Issuer SHOULD avoid additional fields. | <img src="https://github.com/eu-digital-green-certificates/dcc-quality-assurance/blob/main/NL/1.3.0/specialcases/TEST_EMPTY_DR_FIELD.png">
| Interpretation of Validity Dates has a different model. Maximum Lifetime is longer than the validUntil Date. Time Range can be greater than 180 Days. This can lead to rejection in case of the 180 days limits for recovery| AT REC Codes | A verifier should check if a holder is in the 180 Day Time Window, instead of checking maximum validity of 180 days. | TBD  |<img src="https://github.com/eu-digital-green-certificates/dcc-quality-assurance/blob/validation3a1/AT/1.0.0/REC.png">
